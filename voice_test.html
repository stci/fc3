<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Speech Synthesis Demo (Smart Voice Selection + Logging)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#version { font-weight: bold; margin-bottom: 10px; }
#voices { margin-top: 10px; }
.auto-selected { padding: 5px; font-weight: bold; color: green; }
#logBox {
  background: #f0f0f0;
  padding: 10px;
  border-radius: 6px;
  height: 200px;
  overflow-y: auto;
  font-family: monospace;
  margin-top: 10px;
  white-space: pre-wrap;
}
#uaBox {
  background: #eef6ff;
  padding: 10px;
  border-radius: 6px;
  font-family: monospace;
  margin-bottom: 20px;
}
</style>
</head>
<body>

<div id="version">Version: 1.2 (Smart Voice Selection + Android Fixes)</div>

<h2>Speech Synthesis Demo</h2>

<h3>User Agent Info</h3>
<div id="uaBox"></div>

<label>Language:</label>
<select id="lang">
  <option value="en-GB">English (en-GB)</option>
  <option value="de-DE">German (de-DE)</option>
</select>

<br><br>

<label>Text to speak:</label><br>
<textarea id="text" rows="4" cols="60">Hello, how are you?</textarea>

<br><br>

<div id="auto" class="auto-selected"></div>

<label>Available voices:</label>
<div id="voices"></div>

<h3>Selection Log</h3>
<div id="logBox"></div>

<br>
<button id="speakBtn">Speak</button>

<script>
/* ============================================
   UTIL: Log to page
   ============================================ */
function log(msg) {
  const logBox = document.getElementById("logBox");
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}

/* ============================================
   SHOW USER AGENT DETAILS
   ============================================ */
const uaBox = document.getElementById("uaBox");
uaBox.textContent =
  "userAgent: " + navigator.userAgent + "\n" +
  "platform: " + navigator.platform + "\n" +
  "language: " + navigator.language + "\n" +
  "vendor: " + navigator.vendor;

/* ============================================
   SMART CROSS-PLATFORM BEST VOICE SELECTOR
   ============================================ */
function getBestVoice(lang, callback) {
  const ua = navigator.userAgent;

  const isIOS =
    (/iPad|iPhone|iPod/.test(ua)) ||
    (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

  const isAndroid = /Android/i.test(ua);

  log("=== Starting voice selection for: " + lang + " ===");
  log("Detected iOS: " + isIOS);
  log("Detected Android: " + isAndroid);

  function loadVoices() {
    let voices = speechSynthesis.getVoices();
    log("Voices loaded: " + voices.length);

    if (isIOS && !voices.length) {
      log("iOS: Voices empty → retry loop started…");
      let attempts = 0;

      const interval = setInterval(() => {
        voices = speechSynthesis.getVoices();
        attempts++;

        if (voices.length) {
          clearInterval(interval);
          log("iOS: Voices loaded after attempts: " + attempts);
          selectVoice(voices);
        } else if (attempts > 20) {
          log("iOS: Giving up after 20 attempts.");
          clearInterval(interval);
          selectVoice(voices);
        }
      }, 100);

    } else {
      selectVoice(voices);
    }
  }

  function selectVoice(voices) {
    if (!voices.length) {
      log("No voices available.");
      return callback(null);
    }

    const langPrefix = lang.toLowerCase();

    function isBadMultilingual(v) {
      const n = v.name.toLowerCase();
      // Android multilingual voices are valid
      if (isAndroid) return false;
      return n.includes("multilingual") || n.includes("universal");
    }

    /* iOS special handling */
    if (isIOS) {
      if (langPrefix === "de-de") {
        log("iOS German: Searching Anna → Markus → Petra → Klara…");
        const priority = ["anna", "markus", "petra", "klara"];
        for (const key of priority) {
          const v = voices.find(x =>
            x.lang.toLowerCase() === "de-de" &&
            x.name.toLowerCase().includes(key)
          );
          if (v) {
            log("Found: " + v.name);
            return callback(v);
          }
        }
        log("Fallback iOS DE: any de-DE no-multilingual");
        const v = voices.find(x =>
          x.lang.toLowerCase() === "de-de" && !isBadMultilingual(x)
        );
        if (v) return callback(v);
      }

      if (langPrefix === "en-gb") {
        log("iOS English: Searching Daniel…");
        const v = voices.find(x =>
          x.lang.toLowerCase() === "en-gb" &&
          x.name.toLowerCase().includes("daniel")
        );
        if (v) return callback(v);
      }
    }

    /* Edge Online Natural */
    if (/Edg\//.test(ua)) {
      log("Edge detected → Online Natural search…");
      const v = voices.find(x =>
        x.lang.toLowerCase() === langPrefix &&
        !isBadMultilingual(x) &&
        x.name.toLowerCase().includes("online") &&
        x.name.toLowerCase().includes("natural")
      );
      if (v) {
        log("Using Online Natural: " + v.name);
        return callback(v);
      }
    }

    /* Exact match (with _ → - normalization for Android) */
    log("Exact match search for: " + langPrefix);
    let exact = voices.find(v => {
      const vLang = v.lang.toLowerCase().replace('_','-');
      return vLang === langPrefix && !isBadMultilingual(v);
    });

    // Fuzzy fallback for Android if exact fails
    if (!exact && isAndroid) {
      exact = voices.find(v =>
        v.lang.toLowerCase().replace('_','-').startsWith(langPrefix.substring(0,2)) &&
        !isBadMultilingual(v)
      );
      if (exact) log("Using fuzzy match for Android: " + exact.name);
    }

    if (exact) {
      log("Selected voice: " + exact.name);
      return callback(exact);
    }

    /* Preferred fallback */
    const preferred = {
      "de-de": ["katja", "conrad"],
      "en-gb": []
    }[langPrefix] || [];

    if (preferred.length) {
      log("Searching preferred: " + preferred.join(", "));
      const p = voices.find(x =>
        x.lang.toLowerCase() === langPrefix &&
        !isBadMultilingual(x) &&
        preferred.some(p => x.name.toLowerCase().includes(p))
      );
      if (p) return callback(p);
    }

    /* Normal fallback */
    log("Normal fallback: any matching locale.");
    const fallback = voices.find(x =>
      x.lang.toLowerCase() === langPrefix &&
      !isBadMultilingual(x)
    );
    if (fallback) return callback(fallback);

    log("No voice found → null");
    callback(null);
  }

  if (speechSynthesis.getVoices().length > 0) loadVoices();
  else speechSynthesis.addEventListener("voiceschanged", loadVoices, { once: true });
}

/* ============================================
   DEMO UI
   ============================================ */
const langSelect = document.getElementById("lang");
const voicesDiv = document.getElementById("voices");
const autoDiv = document.getElementById("auto");
const textArea = document.getElementById("text");
let selectedVoice = null;

function refreshVoiceUI() {
  document.getElementById("logBox").textContent = "";
  log("Refreshing UI…");

  // Update textarea default text
  if (langSelect.value === "en-GB") textArea.value = "Hello, how are you?";
  if (langSelect.value === "de-DE") textArea.value = "Tschuss. Guten Morgen.";

  const lang = langSelect.value;
  const langLower = lang.toLowerCase();

  getBestVoice(langLower, best => {
    selectedVoice = best;

    autoDiv.textContent = best
      ? "Auto-selected voice: " + best.name + " (" + best.lang + ")"
      : "No auto-selected voice found";

    const voices = speechSynthesis.getVoices();
    voicesDiv.innerHTML = "";

    const exact = voices.filter(v => v.lang.toLowerCase().replace('_','-') === langLower);
    const related = voices.filter(v =>
      v.lang.toLowerCase().replace('_','-').startsWith(langLower.substring(0,2)) &&
      v.lang.toLowerCase().replace('_','-') !== langLower
    );

    const filtered = [...exact, ...related];

    filtered.forEach(v => {
      const checked =
        selectedVoice &&
        selectedVoice.name === v.name
          ? "checked"
          : "";

      voicesDiv.innerHTML += `
        <label>
          <input type="radio" name="voice" value="${v.name}" ${checked}>
          ${v.name} (${v.lang})
        </label><br>
      `;
    });

    voicesDiv.querySelectorAll("input[name=voice]").forEach(r => {
      r.addEventListener("change", () => {
        const voices = speechSynthesis.getVoices();
        selectedVoice = voices.find(v => v.name === r.value);
        log("User selected voice manually: " + selectedVoice.name);
      });
    });
  });
}

langSelect.addEventListener("change", refreshVoiceUI);
speechSynthesis.addEventListener("voiceschanged", refreshVoiceUI);

document.getElementById("speakBtn").addEventListener("click", () => {
  if (!selectedVoice) {
    log("No voice selected → cannot speak");
    return;
  }

  const text = textArea.value;
  const u = new SpeechSynthesisUtterance(text);

  // Android fixes
  u.voice = selectedVoice;
  u.lang = selectedVoice.lang;
  u.localService = false;
  u.voiceURI = selectedVoice.voiceURI;

  if (/Android/i.test(navigator.userAgent)) {
    speechSynthesis.cancel();
    log("speechSynthesis.cancel() called to reset engine on Android");
  }

  log("Speaking with: " + selectedVoice.name + " / lang=" + selectedVoice.lang);
  speechSynthesis.speak(u);
});

refreshVoiceUI();
</script>

</body>
</html>
