<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Speech Synthesis Demo (Smart Voice Selection + Logging)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#voices { margin-top: 10px; }
.auto-selected { padding: 5px; font-weight: bold; color: green; }
#logBox {
  background: #f0f0f0;
  padding: 10px;
  border-radius: 6px;
  height: 200px;
  overflow-y: auto;
  font-family: monospace;
  margin-top: 10px;
  white-space: pre-wrap;
}
#uaBox {
  background: #eef6ff;
  padding: 10px;
  border-radius: 6px;
  font-family: monospace;
  margin-bottom: 20px;
}
</style>
</head>
<body>

<h2>Speech Synthesis Demo</h2>

<h3>User Agent Info</h3>
<div id="uaBox"></div>

<label>Language:</label>
<select id="lang">
  <option value="en-GB">English (en-GB)</option>
  <option value="de-DE">German (de-DE)</option>
</select>

<br><br>

<label>Text to speak:</label><br>
<textarea id="text" rows="4" cols="60">Hello! This is a test.</textarea>

<br><br>

<div id="auto" class="auto-selected"></div>

<label>Available voices:</label>
<div id="voices"></div>

<h3>Selection Log</h3>
<div id="logBox"></div>

<br>
<button id="speakBtn">Speak</button>

<script>
/* ============================================
   PAGE LOGGER
   ============================================ */
function log(msg) {
  const logBox = document.getElementById("logBox");
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}

/* ============================================
   SHOW USER AGENT DETAILS
   ============================================ */
const uaBox = document.getElementById("uaBox");
uaBox.textContent =
  "userAgent: " + navigator.userAgent + "\n" +
  "platform: " + navigator.platform + "\n" +
  "language: " + navigator.language + "\n" +
  "vendor: " + navigator.vendor + "\n" +
  "maxTouchPoints: " + navigator.maxTouchPoints;

/* ============================================
   SMART CROSS-PLATFORM BEST VOICE SELECTOR
   UPDATED: iPadOS detection, EN logic, DE logic
   ============================================ */
function getBestVoice(lang, callback) {
  const ua = navigator.userAgent;

  // *** UPDATED *** Modern iPad detection
  const isIOS =
    /iPad|iPhone|iPod/.test(ua) ||
    (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

  const target = lang.toLowerCase();
  const baseLang = target.split(/[-_]/)[0]; // en-gb → en

  log("=== Starting voice selection for: " + lang + " ===");
  log("Detected iOS (real): " + isIOS);

  function normalize(l) {
    return l.toLowerCase().replace("_", "-").split("-")[0];
  }

  function isBad(v) {
    const n = v.name.toLowerCase();
    return n.includes("multilingual") || n.includes("universal");
  }

  function isHighQuality(v) {
    const n = v.name.toLowerCase();
    return (
      n.includes("online") ||
      n.includes("natural") ||
      n.includes("premium") ||
      n.includes("enhanced")
    );
  }

  function loadVoices() {
    let voices = speechSynthesis.getVoices();
    log("Voices loaded: " + voices.length);

    if (isIOS && !voices.length) {
      // iOS loads voices asynchronously
      let attempts = 0;
      log("iOS: voices empty → retry loop starting…");

      const timer = setInterval(() => {
        voices = speechSynthesis.getVoices();
        attempts++;

        if (voices.length) {
          clearInterval(timer);
          log("iOS: voices loaded after attempts: " + attempts);
          selectVoice(voices);
        } else if (attempts > 20) {
          clearInterval(timer);
          log("iOS: giving up after 20 attempts");
          selectVoice(voices);
        }
      }, 100);

    } else {
      selectVoice(voices);
    }
  }

  function selectVoice(voices) {
    if (!voices.length) {
      log("No voices available.");
      return callback(null);
    }

    /* ==================================================
       iOS SPECIAL HANDLING (HIGHEST QUALITY)
       ================================================== */
    if (isIOS) {
      /* ---- iOS German BEST ---- */
      if (baseLang === "de") {
        log("iOS DE: Trying Anna → Markus → Petra → Klara");

        const priority = ["anna", "markus", "petra", "klara"];
        for (const key of priority) {
          const v = voices.find(v =>
            normalize(v.lang) === "de" &&
            v.name.toLowerCase().includes(key)
          );
          if (v) {
            log("iOS DE selected: " + v.name);
            return callback(v);
          }
        }

        // fallback: enhanced de
        let v = voices.find(v =>
          normalize(v.lang) === "de" &&
          v.name.toLowerCase().includes("enhanced")
        );
        if (v) {
          log("iOS DE fallback (enhanced): " + v.name);
          return callback(v);
        }

        // fallback: any de
        v = voices.find(v => normalize(v.lang) === "de");
        if (v) {
          log("iOS DE fallback (any DE): " + v.name);
          return callback(v);
        }
      }

      /* ---- iOS English BEST ---- */
      if (baseLang === "en") {
        log("iOS EN: Trying Daniel → Samantha → Enhanced → en-GB → en-US");

        let v = voices.find(v => v.name.toLowerCase() === "daniel");
        if (v) return callback(v);

        v = voices.find(v => v.name.toLowerCase() === "samantha");
        if (v) return callback(v);

        v = voices.find(v =>
          normalize(v.lang) === "en" &&
          v.name.toLowerCase().includes("enhanced")
        );
        if (v) return callback(v);

        v = voices.find(v => v.lang.toLowerCase() === "en-gb");
        if (v) return callback(v);

        v = voices.find(v => v.lang.toLowerCase() === "en-us");
        if (v) return callback(v);

        v = voices.find(v => normalize(v.lang) === "en");
        if (v) return callback(v);
      }
    }

    /* ==================================================
       MICROSOFT EDGE SPECIAL HANDLING (Online Natural)
       ================================================== */
    if (/Edg\//.test(ua)) {
      log("Edge detected → searching for Online/Natural voices…");
      let v = voices.find(v =>
        normalize(v.lang) === baseLang &&
        isHighQuality(v) &&
        !isBad(v)
      );
      if (v) {
        log("Edge picked: " + v.name);
        return callback(v);
      }
    }

    /* ==================================================
       Exact locale (Android & others)
       ================================================== */
    log("Searching exact locale: " + target);
    let v = voices.find(v =>
      v.lang.toLowerCase() === target && !isBad(v)
    );
    if (v) {
      log("Exact locale match: " + v.name);
      return callback(v);
    }

    /* ==================================================
       High-quality same-base-language
       ================================================== */
    log("Searching HQ same-base-language matches: " + baseLang);
    v = voices.find(v =>
      normalize(v.lang) === baseLang &&
      isHighQuality(v) &&
      !isBad(v)
    );
    if (v) {
      log("HQ match: " + v.name);
      return callback(v);
    }

    /* ==================================================
       Any same-base-language
       ================================================== */
    log("Searching ANY same-base-language match");
    v = voices.find(v =>
      normalize(v.lang) === baseLang &&
      !isBad(v)
    );
    if (v) {
      log("Base-language match: " + v.name);
      return callback(v);
    }

    /* ==================================================
       Fallback
       ================================================== */
    log("Searching fallback voices");
    v = voices.find(v =>
      v.lang.toLowerCase().startsWith(baseLang)
    );
    if (v) {
      log("Fallback voice: " + v.name);
      return callback(v);
    }

    log("No voice matched at all.");
    callback(null);
  }

  loadVoices();
}

/* ============================================
   UI HANDLING
   ============================================ */
const langSelect = document.getElementById("lang");
const voicesDiv = document.getElementById("voices");
const autoDiv = document.getElementById("auto");
let selectedVoice = null;

function refreshVoiceUI() {
  document.getElementById("logBox").textContent = "";
  log("Refreshing UI…");

  const lang = langSelect.value.toLowerCase();

  getBestVoice(lang, best => {
    selectedVoice = best;

    autoDiv.textContent = best
      ? "Auto-selected voice: " + best.name + " (" + best.lang + ")"
      : "No auto-selected voice found";

    const allVoices = speechSynthesis.getVoices();
    voicesDiv.innerHTML = "";

    // Show exact + related (same base language)
    const exact = allVoices.filter(v => v.lang.toLowerCase() === lang);
    const base = lang.split("-")[0];
    const related = allVoices.filter(v =>
      v.lang.toLowerCase().startsWith(base) &&
      v.lang.toLowerCase() !== lang
    );

    const list = [...exact, ...related];

    list.forEach(v => {
      const checked =
        selectedVoice && selectedVoice.name === v.name ? "checked" : "";

      voicesDiv.innerHTML += `
        <label>
          <input type="radio" name="voice" value="${v.name}" ${checked}>
          ${v.name} (${v.lang})
        </label><br>
      `;
    });

    voicesDiv.querySelectorAll("input[name=voice]").forEach(r => {
      r.addEventListener("change", () => {
        const voices = speechSynthesis.getVoices();
        selectedVoice = voices.find(v => v.name === r.value);
        log("User manually selected: " + selectedVoice.name);
      });
    });
  });
}

langSelect.addEventListener("change", refreshVoiceUI);
speechSynthesis.addEventListener("voiceschanged", refreshVoiceUI);

document.getElementById("speakBtn").addEventListener("click", () => {
  const text = document.getElementById("text").value;
  const utter = new SpeechSynthesisUtterance(text);

  if (selectedVoice) {
    utter.voice = selectedVoice;
    log("Speaking with: " + selectedVoice.name);
  }

  speechSynthesis.speak(utter);
});

// INITIAL LOAD
refreshVoiceUI();
</script>

</body>
</html>
